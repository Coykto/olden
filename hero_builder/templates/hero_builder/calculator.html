{% extends 'hero_builder/base.html' %}

{% block title %}Combat Calculator - Olden Era{% endblock %}

{% block extra_styles %}
<style>
    .calculator-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }

    @media (max-width: 1000px) {
        .calculator-layout {
            grid-template-columns: 1fr;
        }
    }

    .side-panel {
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        padding: 20px;
    }

    .side-panel.left {
        border-color: #4a7c59;
    }

    .side-panel.right {
        border-color: #7c4a4a;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #444;
    }

    .panel-title {
        font-size: 1.3rem;
        color: #d4af37;
    }

    .hero-selector {
        margin-bottom: 20px;
    }

    .hero-selector select, .unit-selector select {
        width: 100%;
        padding: 10px;
        background: #333;
        border: 1px solid #555;
        color: #e0e0e0;
        border-radius: 4px;
        font-size: 1rem;
    }

    .hero-selector select:focus, .unit-selector select:focus {
        border-color: #d4af37;
        outline: none;
    }

    .hero-preview {
        display: flex;
        gap: 15px;
        padding: 15px;
        background: #333;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .hero-preview img {
        width: 80px;
        height: 90px;
        object-fit: cover;
        border-radius: 4px;
        border: 2px solid #555;
    }

    .hero-preview-info h3 {
        color: #d4af37;
        margin-bottom: 5px;
    }

    .hero-preview-info .faction {
        color: #888;
        font-size: 0.9rem;
    }

    .hero-stats-mini {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .mini-stat {
        text-align: center;
        padding: 5px;
        background: #2a2a2a;
        border-radius: 4px;
    }

    .mini-stat .value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #fff;
    }

    .mini-stat .label {
        font-size: 0.8rem;
        color: #888;
    }

    .level-input {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
    }

    .level-input label {
        color: #aaa;
    }

    .level-input input {
        width: 60px;
        padding: 8px;
        background: #333;
        border: 1px solid #555;
        color: #fff;
        border-radius: 4px;
        text-align: center;
    }

    .army-section {
        margin-top: 20px;
    }

    .army-section h4 {
        color: #d4af37;
        margin-bottom: 15px;
    }

    .unit-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }

    .unit-row select {
        flex: 1;
    }

    .unit-row input[type="number"] {
        width: 80px;
        padding: 8px;
        background: #333;
        border: 1px solid #555;
        color: #fff;
        border-radius: 4px;
        text-align: center;
    }

    .unit-stats-preview {
        font-size: 0.85rem;
        color: #888;
        padding: 5px 10px;
        background: #2a2a2a;
        border-radius: 4px;
        margin-top: 5px;
    }

    .calculate-section {
        margin-top: 30px;
        padding: 20px;
        background: #2a2a2a;
        border: 2px solid #d4af37;
        border-radius: 8px;
    }

    .calculate-section h3 {
        color: #d4af37;
        margin-bottom: 20px;
        text-align: center;
    }

    .attacker-defender-select {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
    }

    .vs-label {
        color: #d4af37;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .calculate-btn {
        display: block;
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        margin-top: 20px;
    }

    .result-box {
        margin-top: 20px;
        padding: 20px;
        background: #333;
        border-radius: 8px;
        display: none;
    }

    .result-box.visible {
        display: block;
    }

    .result-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .damage-range {
        font-size: 2rem;
        font-weight: bold;
        color: #ff6b6b;
    }

    .damage-avg {
        color: #888;
        font-size: 1rem;
    }

    .kills-info {
        text-align: center;
        margin: 15px 0;
        padding: 15px;
        background: #2a2a2a;
        border-radius: 6px;
    }

    .kills-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #d4af37;
    }

    .modifiers-list {
        margin-top: 15px;
    }

    .modifiers-list h4 {
        color: #aaa;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }

    .modifier-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #444;
        font-size: 0.9rem;
    }

    .modifier-item:last-child {
        border-bottom: none;
    }

    .modifier-source {
        color: #aaa;
    }

    .modifier-value {
        color: #4caf50;
    }

    .modifier-value.negative {
        color: #f44336;
    }

    .probability-info {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #444;
    }

    .prob-item {
        text-align: center;
    }

    .prob-label {
        color: #888;
        font-size: 0.8rem;
    }

    .prob-value {
        color: #d4af37;
        font-weight: bold;
    }

    .morale-warning {
        background: #4a3a00;
        color: #ffd700;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<h2>Combat Damage Calculator</h2>

<div class="calculator-layout">
    <!-- Left Side - Attacker -->
    <div class="side-panel left">
        <div class="panel-header">
            <span class="panel-title">Attacker</span>
        </div>

        <div class="hero-selector">
            <label>Hero (optional)</label>
            <select id="attacker-hero">
                <option value="">-- No Hero (Neutral Army) --</option>
                {% for hero in heroes %}
                <option value="{{ hero.id_key }}"
                        data-portrait="{{ hero.portrait_url }}"
                        data-faction="{{ hero.faction.name }}"
                        data-class="{{ hero.class_type }}"
                        data-offence="{{ hero.start_offence }}"
                        data-defence="{{ hero.start_defence }}"
                        data-spellpower="{{ hero.start_spell_power }}"
                        data-intelligence="{{ hero.start_intelligence }}"
                        data-luck="{{ hero.start_luck }}"
                        data-moral="{{ hero.start_moral }}">
                    {{ hero.display_name }} ({{ hero.faction.name }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="hero-preview" id="attacker-hero-preview" style="display: none;">
            <img id="attacker-portrait" src="" alt="Hero Portrait">
            <div class="hero-preview-info">
                <h3 id="attacker-name"></h3>
                <div class="faction" id="attacker-faction"></div>
                <div class="hero-stats-mini">
                    <div class="mini-stat">
                        <div class="value" id="attacker-off">0</div>
                        <div class="label">OFF</div>
                    </div>
                    <div class="mini-stat">
                        <div class="value" id="attacker-def">0</div>
                        <div class="label">DEF</div>
                    </div>
                    <div class="mini-stat">
                        <div class="value" id="attacker-sp">0</div>
                        <div class="label">SP</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="level-input">
            <label>Hero Level:</label>
            <input type="number" id="attacker-level" value="1" min="1" max="50">
        </div>

        <div class="army-section">
            <h4>Army</h4>
            <div class="unit-row">
                <select id="attacker-unit-1" class="unit-selector">
                    <option value="">-- Select Unit --</option>
                    {% for unit in units %}
                    <option value="{{ unit.id_key }}"
                            data-hp="{{ unit.hp }}"
                            data-offence="{{ unit.offence }}"
                            data-defence="{{ unit.defence }}"
                            data-damage-min="{{ unit.damage_min }}"
                            data-damage-max="{{ unit.damage_max }}"
                            data-tier="{{ unit.tier }}"
                            data-faction="{{ unit.faction.id_key }}">
                        T{{ unit.tier }} {{ unit.display_name }} ({{ unit.faction.name }})
                    </option>
                    {% endfor %}
                </select>
                <input type="number" id="attacker-count-1" value="10" min="1" max="9999" placeholder="Count">
            </div>
            <div class="unit-stats-preview" id="attacker-unit-stats-1"></div>
        </div>
    </div>

    <!-- Right Side - Defender -->
    <div class="side-panel right">
        <div class="panel-header">
            <span class="panel-title">Defender</span>
        </div>

        <div class="hero-selector">
            <label>Hero (optional)</label>
            <select id="defender-hero">
                <option value="">-- No Hero (Neutral Army) --</option>
                {% for hero in heroes %}
                <option value="{{ hero.id_key }}"
                        data-portrait="{{ hero.portrait_url }}"
                        data-faction="{{ hero.faction.name }}"
                        data-class="{{ hero.class_type }}"
                        data-offence="{{ hero.start_offence }}"
                        data-defence="{{ hero.start_defence }}"
                        data-spellpower="{{ hero.start_spell_power }}"
                        data-intelligence="{{ hero.start_intelligence }}"
                        data-luck="{{ hero.start_luck }}"
                        data-moral="{{ hero.start_moral }}">
                    {{ hero.display_name }} ({{ hero.faction.name }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="hero-preview" id="defender-hero-preview" style="display: none;">
            <img id="defender-portrait" src="" alt="Hero Portrait">
            <div class="hero-preview-info">
                <h3 id="defender-name"></h3>
                <div class="faction" id="defender-faction"></div>
                <div class="hero-stats-mini">
                    <div class="mini-stat">
                        <div class="value" id="defender-off">0</div>
                        <div class="label">OFF</div>
                    </div>
                    <div class="mini-stat">
                        <div class="value" id="defender-def">0</div>
                        <div class="label">DEF</div>
                    </div>
                    <div class="mini-stat">
                        <div class="value" id="defender-sp">0</div>
                        <div class="label">SP</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="level-input">
            <label>Hero Level:</label>
            <input type="number" id="defender-level" value="1" min="1" max="50">
        </div>

        <div class="army-section">
            <h4>Army</h4>
            <div class="unit-row">
                <select id="defender-unit-1" class="unit-selector">
                    <option value="">-- Select Unit --</option>
                    {% for unit in units %}
                    <option value="{{ unit.id_key }}"
                            data-hp="{{ unit.hp }}"
                            data-offence="{{ unit.offence }}"
                            data-defence="{{ unit.defence }}"
                            data-damage-min="{{ unit.damage_min }}"
                            data-damage-max="{{ unit.damage_max }}"
                            data-tier="{{ unit.tier }}"
                            data-faction="{{ unit.faction.id_key }}">
                        T{{ unit.tier }} {{ unit.display_name }} ({{ unit.faction.name }})
                    </option>
                    {% endfor %}
                </select>
                <input type="number" id="defender-count-1" value="5" min="1" max="9999" placeholder="Count">
            </div>
            <div class="unit-stats-preview" id="defender-unit-stats-1"></div>
        </div>
    </div>
</div>

<!-- Calculate Section -->
<div class="calculate-section">
    <h3>Damage Calculation</h3>

    <button class="calculate-btn" onclick="calculateDamage()">Calculate Damage</button>

    <div class="result-box" id="result-box">
        <div class="result-header">
            <div class="damage-range" id="damage-range">0 - 0</div>
            <div class="damage-avg">Average: <span id="damage-avg">0</span></div>
        </div>

        <div class="kills-info">
            <div>Estimated Kills</div>
            <div class="kills-value" id="kills-range">0 - 0</div>
            <div style="color: #888; font-size: 0.9rem;">Average: <span id="kills-avg">0</span></div>
        </div>

        <div class="modifiers-list">
            <h4>Modifiers Applied</h4>
            <div id="modifiers-container"></div>
        </div>

        <div class="probability-info">
            <div class="prob-item">
                <div class="prob-label">Luck Trigger</div>
                <div class="prob-value" id="luck-chance">0%</div>
            </div>
            <div class="prob-item">
                <div class="prob-label">Morale Trigger</div>
                <div class="prob-value" id="morale-chance">0%</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Update hero preview when selection changes
function updateHeroPreview(side) {
    const select = document.getElementById(`${side}-hero`);
    const preview = document.getElementById(`${side}-hero-preview`);
    const option = select.options[select.selectedIndex];

    if (!option.value) {
        preview.style.display = 'none';
        return;
    }

    preview.style.display = 'flex';
    document.getElementById(`${side}-portrait`).src = option.dataset.portrait;
    document.getElementById(`${side}-name`).textContent = option.text.split(' (')[0];
    document.getElementById(`${side}-faction`).textContent = option.dataset.faction + ' - ' + option.dataset.class;
    document.getElementById(`${side}-off`).textContent = option.dataset.offence;
    document.getElementById(`${side}-def`).textContent = option.dataset.defence;
    document.getElementById(`${side}-sp`).textContent = option.dataset.spellpower;
}

// Update unit stats preview
function updateUnitStats(side, index) {
    const select = document.getElementById(`${side}-unit-${index}`);
    const preview = document.getElementById(`${side}-unit-stats-${index}`);
    const option = select.options[select.selectedIndex];

    if (!option.value) {
        preview.textContent = '';
        return;
    }

    const hp = option.dataset.hp;
    const off = option.dataset.offence;
    const def = option.dataset.defence;
    const dmgMin = option.dataset.damageMin;
    const dmgMax = option.dataset.damageMax;

    preview.textContent = `HP: ${hp} | OFF: ${off} | DEF: ${def} | DMG: ${dmgMin}-${dmgMax}`;
}

// Calculate damage via API
async function calculateDamage() {
    const attackerUnit = document.getElementById('attacker-unit-1').value;
    const attackerCount = document.getElementById('attacker-count-1').value;
    const defenderUnit = document.getElementById('defender-unit-1').value;
    const defenderCount = document.getElementById('defender-count-1').value;

    if (!attackerUnit || !defenderUnit) {
        alert('Please select units for both attacker and defender');
        return;
    }

    const requestData = {
        attacker: {
            unit_id: attackerUnit,
            count: parseInt(attackerCount)
        },
        defender: {
            unit_id: defenderUnit,
            count: parseInt(defenderCount)
        }
    };

    // Add hero data if selected
    const attackerHero = document.getElementById('attacker-hero').value;
    if (attackerHero) {
        requestData.attacker_hero = {
            hero_id: attackerHero,
            level: parseInt(document.getElementById('attacker-level').value)
        };
    }

    const defenderHero = document.getElementById('defender-hero').value;
    if (defenderHero) {
        requestData.defender_hero = {
            hero_id: defenderHero,
            level: parseInt(document.getElementById('defender-level').value)
        };
    }

    try {
        const response = await fetch('{% url "hero_builder:api_calculate_damage" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (response.ok) {
            displayResult(result);
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to calculate damage');
    }
}

function displayResult(result) {
    const resultBox = document.getElementById('result-box');
    resultBox.classList.add('visible');

    // Damage range
    document.getElementById('damage-range').textContent =
        `${result.base_result.min_damage} - ${result.base_result.max_damage}`;
    document.getElementById('damage-avg').textContent = result.base_result.avg_damage;

    // Kills
    document.getElementById('kills-range').textContent =
        `${result.base_result.kills_min} - ${result.base_result.kills_max}`;
    document.getElementById('kills-avg').textContent = result.base_result.kills_avg;

    // Modifiers
    const modifiersContainer = document.getElementById('modifiers-container');
    modifiersContainer.innerHTML = '';

    result.modifiers.forEach(mod => {
        const div = document.createElement('div');
        div.className = 'modifier-item';

        let valueText = '';
        if (typeof mod.value === 'number') {
            if (mod.type === 'multiplier' || mod.type.includes('Perc') || mod.type.includes('Mod')) {
                valueText = (mod.value >= 0 ? '+' : '') + (mod.value * 100).toFixed(0) + '%';
            } else {
                valueText = mod.value.toString();
            }
        } else {
            valueText = mod.description || mod.value;
        }

        div.innerHTML = `
            <span class="modifier-source">${mod.source}</span>
            <span class="modifier-value ${mod.value < 0 ? 'negative' : ''}">${valueText}</span>
        `;
        modifiersContainer.appendChild(div);
    });

    // Probabilities
    document.getElementById('luck-chance').textContent =
        (result.luck_chance * 100).toFixed(0) + '%';
    document.getElementById('morale-chance').textContent =
        (result.morale_chance * 100).toFixed(0) + '%';
}

// Event listeners
document.getElementById('attacker-hero').addEventListener('change', () => updateHeroPreview('attacker'));
document.getElementById('defender-hero').addEventListener('change', () => updateHeroPreview('defender'));
document.getElementById('attacker-unit-1').addEventListener('change', () => updateUnitStats('attacker', 1));
document.getElementById('defender-unit-1').addEventListener('change', () => updateUnitStats('defender', 1));
</script>
{% endblock %}
