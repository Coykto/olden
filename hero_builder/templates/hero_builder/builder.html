{% extends "hero_builder/base.html" %}

{% block title %}{{ hero.display_name }} - Hero Builder{% endblock %}

{% block extra_styles %}
<style>
    .builder-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .builder-header {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .builder-title {
        font-size: 1.8rem;
        color: #fff;
        font-weight: bold;
    }

    .pick-hero-btn {
        background: #1e2530;
        border: 1px solid #3a4555;
        color: #8899aa;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        text-decoration: none;
    }

    .pick-hero-btn:hover {
        background: #2a3545;
        border-color: #5a6575;
    }

    /* Main content area */
    .builder-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Hero Card */
    .hero-card {
        background: #1a1f28;
        border: 1px solid #2a3545;
        border-radius: 12px;
    }

    /* Hero Header - Portrait + Name + Stats + Skills */
    .hero-header {
        display: flex;
        border-bottom: 1px solid #2a3545;
    }

    /* Portrait Column */
    .portrait-column {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        border-right: 1px solid #2a3545;
    }

    .hero-portrait-wrapper {
        position: relative;
        width: 150px;
        height: 150px;
    }

    .hero-portrait {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #3a4555;
    }

    .class-badge {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 2px solid #c9a227;
    }

    /* Info Column */
    .info-column {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* Name Row */
    .name-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px 20px;
        border-bottom: 1px solid #2a3545;
    }

    .faction-badge {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        border: 1px solid #3a4555;
        padding: 4px;
        background: #252d38;
    }

    .name-text {
        display: flex;
        flex-direction: column;
    }

    .hero-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: #fff;
    }

    .hero-class {
        color: #8899aa;
        font-size: 0.95rem;
        text-transform: capitalize;
    }

    /* Stats + Skills Row */
    .stats-skills-row {
        display: flex;
        padding: 15px 20px;
        gap: 30px;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px 24px;
        align-content: center;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-icon {
        width: 22px;
        height: 22px;
    }

    .stat-value {
        color: #fff;
        font-weight: 500;
        font-size: 1rem;
    }

    /* Skills Grid - 4 columns, 2 rows */
    .skills-grid {
        display: grid;
        grid-template-columns: repeat(4, auto);
        gap: 10px;
        flex: 1;
    }

    /* Skill Slot with 2 Subskill buttons stacked */
    .skill-with-subs {
        display: flex;
        gap: 4px;
    }

    .skill-main {
        width: 60px;
        height: 60px;
        background: #252d38;
        border: 1px solid #3a4555;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
        transition: all 0.15s;
    }

    .skill-main:hover {
        border-color: #5a7090;
        background: #2a3545;
    }

    .skill-main img {
        width: 52px;
        height: 52px;
        border-radius: 6px;
    }

    /* Skill tooltip - uses shared .tooltip-content from components.css */

    .skill-add-text {
        color: #5a6575;
        font-size: 1.5rem;
        font-weight: 300;
    }

    .skill-main:hover .skill-add-text {
        color: #8899aa;
    }

    /* 2 Subskill buttons stacked vertically */
    .subskill-column {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 4px;
    }

    .subskill-btn {
        width: 28px;
        height: 28px;
        background: #252d38;
        border: 1px solid #3a4555;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
    }

    .subskill-btn:hover {
        border-color: #5a7090;
        background: #2a3545;
    }

    .subskill-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .subskill-btn.filled {
        cursor: pointer;
    }

    .subskill-btn.filled .tooltip-content {
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        margin-left: 10px;
        min-width: 200px;
        max-width: 280px;
        white-space: normal;
    }

    .subskill-btn .add-text {
        color: #5a6575;
        font-size: 0.85rem;
    }

    .subskill-btn:hover .add-text {
        color: #8899aa;
    }

    .subskill-btn img {
        width: 22px;
        height: 22px;
        border-radius: 4px;
    }

    /* Equipment + Backpack Row */
    .equip-spells-row {
        display: flex;
        gap: 15px;
    }

    /* Equipment Section - flexbox rows around hero silhouette */
    .equipment-section {
        background: #1a1f28;
        border: 1px solid #2a3545;
        border-radius: 12px;
        padding: 1rem;
    }

    .equipment-silhouette {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    /* Each row: 3 columns with space-between */
    .equip-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    /* Left/Right columns align to edges, center is centered */
    .equip-col-left,
    .equip-col-right {
        flex: 0 0 auto;
    }

    .equip-col-center {
        flex: 0 0 auto;
        margin: 0 1rem 0 1rem;
    }

    /* Center offset - pushes center item down slightly */
    .offset-down {
        margin-top: 2rem;
    }

    /* Empty placeholder for rows without center item */
    .equip-col-empty {
        visibility: hidden;
    }

    .equip-slot {
        width: 3.5rem;
        height: 3.5rem;
        background: #252d38;
        border: 1px solid #3a4555;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
        margin: 0.5rem;
    }

    .equip-slot:hover {
        border-color: #5a7090;
    }

    .equip-slot img {
        width: 70%;
        height: 70%;
        opacity: 0.35;
    }

    .equip-slot:hover img {
        opacity: 0.5;
    }

    /* Backpack Section (4x6 grid) */
    .backpack-section {
        background: #1a1f28;
        border: 1px solid #2a3545;
        border-radius: 12px;
        padding: 15px;
        flex: 1;
    }

    .backpack-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }

    .backpack-slot {
        width: 55px;
        height: 55px;
        background: #252d38;
        border: 1px solid #3a4555;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
    }

    .backpack-slot:hover {
        border-color: #5a7090;
    }

    .backpack-slot .add-text {
        color: #5a6575;
        font-size: 1.2rem;
    }

    .backpack-slot:hover .add-text {
        color: #8899aa;
    }

    /* Units Section */
    .units-section {
        background: #1a1f28;
        border: 1px solid #2a3545;
        border-radius: 12px;
        padding: 15px;
    }

    .units-grid {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .unit-slot {
        width: 75px;
        height: 75px;
        background: #252d38;
        border: 1px solid #3a4555;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
    }

    .unit-slot:hover {
        border-color: #5a7090;
    }

    .unit-slot .add-text {
        color: #5a6575;
        font-size: 1.3rem;
    }

    .unit-slot:hover .add-text {
        color: #8899aa;
    }

    /* Right Skill Panel */
    .right-skills-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .right-skill-slot {
        width: 55px;
        height: 55px;
        background: #252d38;
        border: 1px solid #3a4555;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s;
    }

    .right-skill-slot:hover {
        border-color: #5a7090;
    }

    .right-skill-slot .add-text {
        color: #5a6575;
        font-size: 1.2rem;
    }

    .right-skill-slot:hover .add-text {
        color: #8899aa;
    }

    /* Main + Sidebar layout */
    .main-with-sidebar {
        display: flex;
        gap: 12px;
    }

    .main-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .hero-header {
            flex-direction: column;
        }
        .portrait-column {
            border-right: none;
            border-bottom: 1px solid #2a3545;
        }
        .stats-skills-row {
            flex-direction: column;
        }
        .skills-grid {
            grid-template-columns: repeat(2, auto);
        }
        .equip-spells-row {
            flex-direction: column;
        }
        .main-with-sidebar {
            flex-direction: column;
        }
        .right-skills-panel {
            flex-direction: row;
            justify-content: center;
        }
    }

    /* Modal Overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    /* Skill Selection Modal */
    .skill-modal {
        background: linear-gradient(180deg, #1a2030 0%, #141820 100%);
        border: 2px solid #3a4555;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #2a3545;
    }

    .modal-header h2 {
        color: #c9a227;
        font-size: 1.3rem;
        margin: 0 0 15px 0;
        text-transform: uppercase;
    }

    .skill-search {
        width: 100%;
        padding: 12px 15px;
        background: #252d38;
        border: 1px solid #3a4555;
        border-radius: 8px;
        color: #fff;
        font-size: 1rem;
    }

    .skill-search::placeholder {
        color: #5a6575;
    }

    .skill-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    /* Skill Option */
    .skill-option {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 15px;
        margin: 8px 0;
        background: #1e2530;
        border: 2px solid #2a3545;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .skill-option:hover {
        border-color: #5a7090;
        background: #252d38;
    }

    .skill-icon {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        border: 1px solid #3a4555;
    }

    .skill-info {
        flex: 1;
    }

    .skill-name {
        color: #c9a227;
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .skill-desc {
        color: #8899aa;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .subskill-previews {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        max-width: 140px;
        justify-content: flex-end;
        align-content: flex-start;
        align-self: flex-start;
    }

    .subskill-preview-wrapper {
        position: relative;
    }

    .subskill-preview-wrapper .tooltip-content {
        left: auto;
        right: 100%;
        top: 50%;
        transform: translateY(-50%);
        margin-right: 10px;
        min-width: 200px;
        max-width: 280px;
        white-space: normal;
        z-index: 1001;
    }

    .subskill-preview-icon {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .subskill-preview-wrapper:hover .subskill-preview-icon {
        opacity: 1;
    }

    /* Subskill Selection Modal */
    .subskill-modal {
        background: linear-gradient(180deg, #1a2030 0%, #141820 100%);
        border: 2px solid #3a4555;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        padding: 20px;
    }

    .upgraded-skill {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        margin-bottom: 20px;
        background: #1e2530;
        border: 2px solid #c9a227;
        border-radius: 10px;
    }

    .skill-icon-large {
        width: 70px;
        height: 70px;
        border-radius: 8px;
    }

    .subskill-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .subskill-option {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #1e2530;
        border: 2px solid #2a3545;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .subskill-option:hover {
        border-color: #5a9090;
        background: #252d38;
    }

    .subskill-icon {
        width: 50px;
        height: 50px;
        border-radius: 8px;
    }

    .subskill-name {
        color: #7ec8e3;
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 4px;
    }

    .subskill-desc {
        color: #8899aa;
        font-size: 0.85rem;
        line-height: 1.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="builder-container">
    <div class="builder-header">
        <h1 class="builder-title">Hero Builder</h1>
        <a href="{% url 'hero_builder:faction_heroes' hero.faction.slug %}" class="pick-hero-btn">Pick Hero</a>
    </div>

    <div class="main-with-sidebar">
        <div class="main-column">
            <!-- Hero Card -->
            <div class="hero-card" data-hero-faction="{{ hero.faction.slug }}" data-hero-id="{{ hero.game_id }}">
                <div class="hero-header">
                    <!-- Portrait Column -->
                    <div class="portrait-column">
                        <div class="hero-portrait-wrapper">
                            {% if hero.portrait_url %}
                            <img src="{{ hero.portrait_url }}" alt="{{ hero.display_name }}" class="hero-portrait">
                            {% else %}
                            <div class="hero-portrait" style="background: linear-gradient(180deg, #333 0%, #222 100%);"></div>
                            {% endif %}
                        </div>
                        <img src="{{ hero.class_icon_url }}" alt="{{ hero.class_type }}" class="class-badge">
                    </div>

                    <!-- Info Column -->
                    <div class="info-column">
                        <!-- Name Row -->
                        <div class="name-row">
                            <img src="{{ hero.faction.icon_url }}" alt="{{ hero.faction.name }}" class="faction-badge">
                            <div class="name-text">
                                <span class="hero-name">{{ hero.display_name }}</span>
                                <span class="hero-class">{{ hero.specialization_name|default:hero.class_type }}</span>
                            </div>
                        </div>

                        <!-- Stats + Skills Row -->
                        <div class="stats-skills-row">
                            <!-- Stats Grid -->
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <img src="/media/gamedata/ui/stat_attack.png" alt="ATK" class="stat-icon">
                                    <span class="stat-value">{{ hero.start_offence }}</span>
                                </div>
                                <div class="stat-item">
                                    <img src="/media/gamedata/ui/stat_defence.png" alt="DEF" class="stat-icon">
                                    <span class="stat-value">{{ hero.start_defence }}</span>
                                </div>
                                <div class="stat-item">
                                    <img src="/media/gamedata/ui/stat_spellpower.png" alt="PWR" class="stat-icon">
                                    <span class="stat-value">{{ hero.start_spell_power }}</span>
                                </div>
                                <div class="stat-item">
                                    <img src="/media/gamedata/ui/stat_spellpower.png" alt="KNW" class="stat-icon" style="filter: hue-rotate(180deg);">
                                    <span class="stat-value">{{ hero.start_intelligence }}</span>
                                </div>
                                <div class="stat-item">
                                    <img src="/media/gamedata/ui/stat_luck.png" alt="LCK" class="stat-icon">
                                    <span class="stat-value">{{ hero.start_luck }}</span>
                                </div>
                                <div class="stat-item">
                                    <img src="/media/gamedata/ui/stat_morale.png" alt="MRL" class="stat-icon">
                                    <span class="stat-value">{{ hero.start_moral }}</span>
                                </div>
                            </div>

                            <!-- Skills Grid (4 columns, 2 rows) -->
                            <div class="skills-grid">
                                {% for skill in hero.starting_skills_with_levels %}
                                <!-- Skill with 2 stacked subskill slots -->
                                <div class="skill-with-subs">
                                    <div class="skill-main tooltip-wrapper" id="skill-{{ forloop.counter }}" data-skill-id="{{ skill.id }}" data-skill-level="{{ skill.level }}">
                                        <img src="/media/gamedata/skills/{{ skill.id }}{{ skill.icon_suffix }}.png" alt="{{ skill.level_prefix }}{{ skill.name }}">
                                        <div class="tooltip-content">
                                            <div class="tooltip-name">{{ skill.level_prefix }}{{ skill.name }}</div>
                                            {% if skill.description %}
                                            <div class="tooltip-desc">{{ skill.description }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="subskill-column">
                                        <div class="subskill-btn">
                                            <span class="add-text">+</span>
                                        </div>
                                        <div class="subskill-btn disabled"></div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Empty skill slots to fill first row (4 total) -->
                                {% with hero.starting_skills_with_levels|length as skill_count %}
                                {% if skill_count < 4 %}
                                {% for i in "1234"|make_list %}
                                {% if forloop.counter > skill_count %}
                                <div class="skill-with-subs">
                                    <div class="skill-main">
                                        <span class="skill-add-text">+</span>
                                    </div>
                                    <div class="subskill-column">
                                        <div class="subskill-btn disabled"></div>
                                        <div class="subskill-btn disabled"></div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                {% endwith %}

                                <!-- Second row - 4 empty slots -->
                                {% for i in "1234"|make_list %}
                                <div class="skill-with-subs">
                                    <div class="skill-main">
                                        <span class="skill-add-text">+</span>
                                    </div>
                                    <div class="subskill-column">
                                        <div class="subskill-btn disabled"></div>
                                        <div class="subskill-btn disabled"></div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment + Backpack Row -->
            <div class="equip-spells-row">
                <!-- Equipment - 5 rows around hero silhouette -->
                <div class="equipment-section" id="equipment-panel">
                    <div class="equipment-silhouette">
                        <!-- Row 1: Unique, Head (offset down), Back -->
                        <div class="equip-row">
                            <div class="equip-col-left">
                                <div class="equip-slot" id="slot-unique" data-slot-type="unique">
                                    <img src="/media/gamedata/ui/slot_unique.png" alt="Unique">
                                </div>
                            </div>
                            <div class="equip-col-center offset-down">
                                <div class="equip-slot" id="slot-head" data-slot-type="head">
                                    <img src="/media/gamedata/ui/slot_head.png" alt="Head">
                                </div>
                            </div>
                            <div class="equip-col-right">
                                <div class="equip-slot" id="slot-back" data-slot-type="back">
                                    <img src="/media/gamedata/ui/slot_cloak.png" alt="Back">
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Ring, Armor, Ring -->
                        <div class="equip-row">
                            <div class="equip-col-left">
                                <div class="equip-slot" id="slot-ring-1" data-slot-type="ring">
                                    <img src="/media/gamedata/ui/slot_ring.png" alt="Ring">
                                </div>
                            </div>
                            <div class="equip-col-center">
                                <div class="equip-slot" id="slot-armor" data-slot-type="armor">
                                    <img src="/media/gamedata/ui/slot_armor.png" alt="Armor">
                                </div>
                            </div>
                            <div class="equip-col-right">
                                <div class="equip-slot" id="slot-ring-2" data-slot-type="ring">
                                    <img src="/media/gamedata/ui/slot_ring.png" alt="Ring">
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Weapon, Belt, Shield -->
                        <div class="equip-row">
                            <div class="equip-col-left">
                                <div class="equip-slot" id="slot-weapon" data-slot-type="weapon">
                                    <img src="/media/gamedata/ui/slot_left_hand.png" alt="Weapon">
                                </div>
                            </div>
                            <div class="equip-col-center">
                                <div class="equip-slot" id="slot-belt" data-slot-type="belt">
                                    <img src="/media/gamedata/ui/slot_belt.png" alt="Belt">
                                </div>
                            </div>
                            <div class="equip-col-right">
                                <div class="equip-slot" id="slot-shield" data-slot-type="shield">
                                    <img src="/media/gamedata/ui/slot_right_hand.png" alt="Shield">
                                </div>
                            </div>
                        </div>

                        <!-- Row 4: Accessory, (empty), Accessory -->
                        <div class="equip-row">
                            <div class="equip-col-left offset-down">
                                <div class="equip-slot" id="slot-accessory-1" data-slot-type="accessory">
                                    <img src="/media/gamedata/ui/slot_item.png" alt="Accessory">
                                </div>
                            </div>
                            <div class="equip-col-center equip-col-empty">
                                <div class="equip-slot"></div>
                            </div>
                            <div class="equip-col-right offset-down">
                                <div class="equip-slot" id="slot-accessory-2" data-slot-type="accessory">
                                    <img src="/media/gamedata/ui/slot_item.png" alt="Accessory">
                                </div>
                            </div>
                        </div>

                        <!-- Row 5: Accessory, Boots, Accessory -->
                        <div class="equip-row">
                            <div class="equip-col-left">
                                <div class="equip-slot" id="slot-accessory-3" data-slot-type="accessory">
                                    <img src="/media/gamedata/ui/slot_item.png" alt="Accessory">
                                </div>
                            </div>
                            <div class="equip-col-center">
                                <div class="equip-slot" id="slot-boots" data-slot-type="boots">
                                    <img src="/media/gamedata/ui/slot_boots.png" alt="Boots">
                                </div>
                            </div>
                            <div class="equip-col-right">
                                <div class="equip-slot" id="slot-accessory-4" data-slot-type="accessory">
                                    <img src="/media/gamedata/ui/slot_item.png" alt="Accessory">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backpack Grid (4x6) -->
                <div class="backpack-section">
                    <div class="backpack-grid">
                        {% for i in "123456789012345678901234"|make_list %}
                        <div class="backpack-slot">
                            <span class="add-text"></span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Units Row -->
            <div class="units-section">
                <div class="units-grid">
                    {% for i in "1234567"|make_list %}
                    <div class="unit-slot">
                        <span class="add-text">+</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right Skills Panel -->
        <div class="right-skills-panel">
            {% for i in "12345678"|make_list %}
            <div class="right-skill-slot">
                <span class="add-text">+</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<div id="skill-modal-container"></div>

<script>
// Client-side state for hero build
const heroBuild = {
    heroId: '',
    heroFaction: '',
    skills: [],  // Array of 8 slots: {skillId, level, subskills} or null
    startingSkillIds: []
};

const SkillManager = {
    init() {
        // Get hero info from DOM
        const heroCard = document.querySelector('[data-hero-faction]');
        heroBuild.heroFaction = heroCard?.dataset.heroFaction || '';
        heroBuild.heroId = heroCard?.dataset.heroId || '';

        // Initialize skills array with 8 slots
        heroBuild.skills = new Array(8).fill(null);

        // Get starting skills from DOM
        const skillSlots = document.querySelectorAll('.skill-with-subs');
        skillSlots.forEach((slot, index) => {
            const skillMain = slot.querySelector('.skill-main');
            const skillId = skillMain?.dataset.skillId;
            const skillLevel = parseInt(skillMain?.dataset.skillLevel) || 1;

            if (skillId) {
                // Extract name and description from tooltip if present
                const tooltipName = skillMain.querySelector('.tooltip-name')?.textContent || skillId;
                const tooltipDesc = skillMain.querySelector('.tooltip-desc')?.textContent || '';

                // Remove level prefix from name if it exists
                const name = tooltipName.replace(/^(Basic|Advanced|Expert)\s+/, '');

                heroBuild.skills[index] = {
                    skillId: skillId,
                    level: skillLevel,
                    subskills: [null, null],
                    subskillNames: [null, null],
                    subskillDescs: [null, null],
                    name: name,
                    description: tooltipDesc
                };
                heroBuild.startingSkillIds.push(skillId);
            }
        });

        // Set up all click handlers (including subskill buttons for starting skills)
        this.updateUI();
    },

    setupClickHandlers() {
        const skillSlots = document.querySelectorAll('.skill-with-subs');
        skillSlots.forEach((slot, index) => {
            const skillMain = slot.querySelector('.skill-main');

            // Check if it's an empty slot
            if (heroBuild.skills[index] === null) {
                skillMain.style.cursor = 'pointer';
                skillMain.onclick = () => SkillSelectionModal.open(index);
            }
        });
    },

    addSkill(slotIndex, skillId, skillName, skillIcon, skillDescription) {
        heroBuild.skills[slotIndex] = {
            skillId: skillId,
            level: 1,
            subskills: [null, null],
            subskillNames: [null, null],
            subskillDescs: [null, null],
            name: skillName,
            icon: skillIcon,
            description: skillDescription || ''
        };
        this.updateUI();
    },

    getSelectedSkillIds() {
        return heroBuild.skills
            .filter(s => s !== null)
            .map(s => s.skillId);
    },

    levelUpSkill(slotIndex, subskillId, subskillName, subskillDesc) {
        const skill = heroBuild.skills[slotIndex];
        if (!skill || skill.level >= 3) return;

        // Store subskill at the appropriate index (0 for Basic→Advanced, 1 for Advanced→Expert)
        const subskillIndex = skill.level - 1;
        skill.subskills[subskillIndex] = subskillId;
        skill.subskillNames[subskillIndex] = subskillName;
        skill.subskillDescs[subskillIndex] = subskillDesc || '';

        // Increase level
        skill.level++;

        // Update UI
        this.updateUI();
    },

    repickSubskill(slotIndex, subskillSlot, subskillId, subskillName, subskillDesc) {
        const skill = heroBuild.skills[slotIndex];
        if (!skill) return;

        // Replace the subskill at the specified slot (no level change)
        skill.subskills[subskillSlot] = subskillId;
        skill.subskillNames[subskillSlot] = subskillName;
        skill.subskillDescs[subskillSlot] = subskillDesc || '';

        // Update UI
        this.updateUI();
    },

    removeSkill(slotIndex) {
        const skill = heroBuild.skills[slotIndex];
        if (!skill) return;

        // Can't remove starting skills
        if (heroBuild.startingSkillIds.includes(skill.skillId)) {
            alert('Cannot remove starting skills');
            return;
        }

        // Reset slot
        heroBuild.skills[slotIndex] = null;
        this.updateUI();
    },

    updateUI() {
        const skillSlots = document.querySelectorAll('.skill-with-subs');

        heroBuild.skills.forEach((skill, index) => {
            if (index >= skillSlots.length) return;

            const slot = skillSlots[index];
            const skillMain = slot.querySelector('.skill-main');
            const subskillBtns = slot.querySelectorAll('.subskill-btn');

            if (skill === null) {
                // Empty slot - show plus sign
                skillMain.innerHTML = '<span class="skill-add-text">+</span>';
                skillMain.style.cursor = 'pointer';
                skillMain.onclick = () => SkillSelectionModal.open(index);
                skillMain.oncontextmenu = null;
                skillMain.removeAttribute('data-skill-id');

                // Disable both subskill buttons
                subskillBtns.forEach(btn => {
                    btn.className = 'subskill-btn disabled';
                    btn.innerHTML = '';
                    btn.onclick = null;
                });
            } else {
                // Filled slot - show skill icon with tooltip
                const iconSuffix = skill.level > 1 ? `_${skill.level}` : '';
                const levelPrefix = skill.level === 1 ? 'Basic ' : skill.level === 2 ? 'Advanced ' : 'Expert ';

                skillMain.className = 'skill-main tooltip-wrapper';
                skillMain.innerHTML = `
                    <img src="/media/gamedata/skills/${skill.skillId}${iconSuffix}.png" alt="${skill.name || skill.skillId}">
                    <div class="tooltip-content">
                        <div class="tooltip-name">${levelPrefix}${skill.name || skill.skillId}</div>
                        ${skill.description ? `<div class="tooltip-desc">${skill.description}</div>` : ''}
                    </div>
                `;
                skillMain.dataset.skillId = skill.skillId;
                skillMain.dataset.skillLevel = skill.level;

                // Add right-click to remove (only for non-starting skills)
                if (!heroBuild.startingSkillIds.includes(skill.skillId)) {
                    skillMain.oncontextmenu = (e) => {
                        e.preventDefault();
                        if (confirm(`Remove ${skill.name || skill.skillId}?`)) {
                            SkillManager.removeSkill(index);
                        }
                    };
                } else {
                    skillMain.oncontextmenu = null;
                }

                // First subskill button
                if (skill.level === 1) {
                    // Can level up to Advanced
                    subskillBtns[0].className = 'subskill-btn';
                    subskillBtns[0].innerHTML = '<span class="add-text">+</span>';
                    subskillBtns[0].onclick = () => SubskillSelectionModal.open(index);
                } else if (!skill.subskills[0]) {
                    // Level 2+ but no first subskill yet (e.g., Lord Edgar starts at Advanced)
                    // Allow selecting first subskill without leveling up
                    subskillBtns[0].className = 'subskill-btn';
                    subskillBtns[0].innerHTML = '<span class="add-text">+</span>';
                    subskillBtns[0].onclick = () => SubskillSelectionModal.openForRepick(index, 0);
                } else {
                    // Show selected subskill with tooltip - clickable to repick
                    subskillBtns[0].className = 'subskill-btn filled tooltip-wrapper';
                    subskillBtns[0].innerHTML = `
                        <img src="/media/gamedata/skills/${skill.subskills[0]}_icon.png">
                        <div class="tooltip-content">
                            <div class="tooltip-name">${skill.subskillNames[0] || skill.subskills[0]}</div>
                            ${skill.subskillDescs[0] ? `<div class="tooltip-desc">${skill.subskillDescs[0]}</div>` : ''}
                        </div>
                    `;
                    subskillBtns[0].style.cursor = 'pointer';
                    subskillBtns[0].onclick = () => SubskillSelectionModal.openForRepick(index, 0);
                }

                // Second subskill button
                if (skill.level < 2) {
                    // Skill is Basic - second subskill not available
                    subskillBtns[1].className = 'subskill-btn disabled';
                    subskillBtns[1].innerHTML = '';
                    subskillBtns[1].onclick = null;
                } else if (skill.level === 2 && skill.subskills[0]) {
                    // Advanced with first subskill - can level up to Expert
                    subskillBtns[1].className = 'subskill-btn';
                    subskillBtns[1].innerHTML = '<span class="add-text">+</span>';
                    subskillBtns[1].onclick = () => SubskillSelectionModal.open(index);
                } else if (skill.level === 2 && !skill.subskills[0]) {
                    // Advanced but no first subskill - must pick first subskill first
                    subskillBtns[1].className = 'subskill-btn disabled';
                    subskillBtns[1].innerHTML = '';
                    subskillBtns[1].onclick = null;
                } else if (skill.level === 3 && !skill.subskills[1]) {
                    // Expert but no second subskill yet - allow selecting without level change
                    subskillBtns[1].className = 'subskill-btn';
                    subskillBtns[1].innerHTML = '<span class="add-text">+</span>';
                    subskillBtns[1].onclick = () => SubskillSelectionModal.openForRepick(index, 1);
                } else if (skill.subskills[1]) {
                    // Show selected subskill with tooltip - clickable to repick
                    subskillBtns[1].className = 'subskill-btn filled tooltip-wrapper';
                    subskillBtns[1].innerHTML = `
                        <img src="/media/gamedata/skills/${skill.subskills[1]}_icon.png">
                        <div class="tooltip-content">
                            <div class="tooltip-name">${skill.subskillNames[1] || skill.subskills[1]}</div>
                            ${skill.subskillDescs[1] ? `<div class="tooltip-desc">${skill.subskillDescs[1]}</div>` : ''}
                        </div>
                    `;
                    subskillBtns[1].style.cursor = 'pointer';
                    subskillBtns[1].onclick = () => SubskillSelectionModal.openForRepick(index, 1);
                }
            }
        });
    }
};

// Skill Selection Modal with API integration
const SkillSelectionModal = {
    allSkills: [],
    slotIndex: null,

    async open(slotIndex) {
        this.slotIndex = slotIndex;

        // Get faction from hero card data attribute
        const heroFaction = document.querySelector('[data-hero-faction]')?.dataset.heroFaction || '';
        const excludeIds = SkillManager.getSelectedSkillIds().join(',');

        // Fetch skills from API
        try {
            const response = await fetch(`/api/skills/available/?faction=${heroFaction}&exclude=${excludeIds}`);
            const data = await response.json();
            this.allSkills = data.skills || [];
            this.render(this.allSkills);
        } catch (error) {
            console.error('Error fetching skills:', error);
            // Show error state
            const container = document.getElementById('skill-modal-container');
            container.innerHTML = `
                <div class="modal-overlay" onclick="SkillSelectionModal.close()">
                    <div class="skill-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>Select Skill</h2>
                            <p style="color: #ff6666;">Error loading skills. Please try again.</p>
                        </div>
                    </div>
                </div>
            `;
        }
    },

    render(skills) {
        const container = document.getElementById('skill-modal-container');
        container.innerHTML = `
            <div class="modal-overlay" onclick="SkillSelectionModal.close()">
                <div class="skill-modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2>Select Skill</h2>
                        <input type="text"
                               class="skill-search"
                               placeholder="Search skills..."
                               oninput="SkillSelectionModal.filter(this.value)">
                    </div>
                    <div class="skill-list" id="skill-list">
                        ${skills.map(s => this.renderSkillOption(s)).join('')}
                    </div>
                </div>
            </div>
        `;
    },

    renderSkillOption(skill) {
        return `
            <div class="skill-option" data-skill-id="${skill.id}"
                 onclick="SkillSelectionModal.select('${skill.id}')">
                <img src="/media/gamedata/skills/${skill.icon}.png" class="skill-icon" alt="${skill.name}">
                <div class="skill-info">
                    <div class="skill-name">BASIC ${skill.name.toUpperCase()}</div>
                    <div class="skill-desc">${skill.description}</div>
                </div>
                <div class="subskill-previews">
                    ${(skill.subskill_preview || []).map(sub =>
                        `<div class="subskill-preview-wrapper tooltip-wrapper">
                            <img src="/media/gamedata/skills/${sub.icon}.png" class="subskill-preview-icon" alt="${sub.name}">
                            <div class="tooltip-content">
                                <div class="tooltip-name">${sub.name}</div>
                                <div class="tooltip-desc">${sub.description}</div>
                            </div>
                        </div>`
                    ).join('')}
                </div>
            </div>
        `;
    },

    filter(searchText) {
        const filtered = this.allSkills.filter(s =>
            s.name.toLowerCase().includes(searchText.toLowerCase())
        );
        document.getElementById('skill-list').innerHTML =
            filtered.map(s => this.renderSkillOption(s)).join('');
    },

    select(skillId) {
        const skill = this.allSkills.find(s => s.id === skillId);
        if (skill) {
            SkillManager.addSkill(this.slotIndex, skill.id, skill.name, skill.icon, skill.description);
        }
        this.close();
    },

    close() {
        document.getElementById('skill-modal-container').innerHTML = '';
    }
};

const SubskillSelectionModal = {
    slotIndex: null,
    subskillSlot: null,  // 0 or 1, for repicking
    isRepick: false,

    async open(slotIndex) {
        this.slotIndex = slotIndex;
        this.subskillSlot = null;
        this.isRepick = false;
        const skill = heroBuild.skills[slotIndex];
        if (!skill) return;

        const nextLevel = skill.level + 1;
        if (nextLevel > 3) return;  // Already at max level

        try {
            const response = await fetch(`/api/skills/${skill.skillId}/level/${nextLevel}/subskills/`);
            if (!response.ok) throw new Error('Failed to fetch subskills');
            const data = await response.json();
            this.render(data);
        } catch (error) {
            console.error('Error loading subskills:', error);
        }
    },

    async openForRepick(slotIndex, subskillSlot) {
        this.slotIndex = slotIndex;
        this.subskillSlot = subskillSlot;
        this.isRepick = true;
        const skill = heroBuild.skills[slotIndex];
        if (!skill) return;

        // subskillSlot 0 = level 2 subskills, subskillSlot 1 = level 3 subskills
        const level = subskillSlot + 2;

        try {
            const response = await fetch(`/api/skills/${skill.skillId}/level/${level}/subskills/`);
            if (!response.ok) throw new Error('Failed to fetch subskills');
            const data = await response.json();
            this.render(data);
        } catch (error) {
            console.error('Error loading subskills:', error);
        }
    },

    render(data) {
        const container = document.getElementById('skill-modal-container');
        container.innerHTML = `
            <div class="modal-overlay" onclick="SubskillSelectionModal.close()">
                <div class="subskill-modal" onclick="event.stopPropagation()">
                    <div class="upgraded-skill">
                        <img src="/media/gamedata/skills/${data.skill.icon}.png" class="skill-icon-large">
                        <div class="skill-info">
                            <div class="skill-name">${data.skill.name.toUpperCase()}</div>
                            <div class="skill-desc">${data.skill.description}</div>
                        </div>
                    </div>
                    <div class="subskill-options">
                        ${data.subskills.map(sub => this.renderSubskillOption(sub)).join('')}
                    </div>
                </div>
            </div>
        `;
    },

    renderSubskillOption(subskill) {
        return `
            <div class="subskill-option" onclick="SubskillSelectionModal.select('${subskill.id}')">
                <img src="/media/gamedata/skills/${subskill.icon}.png" class="subskill-icon">
                <div class="subskill-info">
                    <div class="subskill-name">${subskill.name}</div>
                    <div class="subskill-desc">${subskill.description}</div>
                </div>
            </div>
        `;
    },

    select(subskillId) {
        // Find the subskill name and description from the rendered data
        const subskillElement = document.querySelector(`.subskill-option[onclick*="${subskillId}"]`);
        const subskillName = subskillElement ?
            subskillElement.querySelector('.subskill-name')?.textContent :
            subskillId;
        const subskillDesc = subskillElement ?
            subskillElement.querySelector('.subskill-desc')?.textContent :
            '';

        if (this.isRepick) {
            SkillManager.repickSubskill(this.slotIndex, this.subskillSlot, subskillId, subskillName, subskillDesc);
        } else {
            SkillManager.levelUpSkill(this.slotIndex, subskillId, subskillName, subskillDesc);
        }
        this.close();
    },

    close() {
        document.getElementById('skill-modal-container').innerHTML = '';
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    SkillManager.init();

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            SkillSelectionModal.close();
            SubskillSelectionModal.close();
        }
    });
});
</script>
{% endblock %}
