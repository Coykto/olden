# Item Description Value System

This document explains how Heroes of Might & Magic: Olden Era fills placeholder values (`{0}`, `{1}`, etc.) in item descriptions.

## Overview

The game uses a multi-layer system to resolve description placeholders:

1. **Localization texts** (`Lang/english/texts/artifacts.json`) - Contains the description templates with `{0}`, `{1}` placeholders
2. **Args definitions** (`Lang/args/artifacts.json`) - Maps each description SID to function names that resolve the placeholders
3. **Script functions** (`Core.zip/DB/info/info_item/item.script`) - Defines the functions that extract values from item/hero data

## Architecture

```
StreamingAssets/
├── Lang/
│   ├── english/texts/artifacts.json    # Localized text with placeholders
│   └── args/artifacts.json             # Maps SIDs to resolver functions
└── Core.zip/
    └── DB/info/                        # Script function definitions
        ├── info_item/item.script       # Item descriptions (1175 functions)
        ├── info_magic/magic_*.script   # Spell descriptions
        ├── info_units/units_*.script   # Unit descriptions
        ├── info_skills/hero_*.script   # Skill descriptions
        └── ... (42 script files total)
```

## Script Transpiler System

Olden Forge uses a **Node.js transpiler** that converts game script files to JavaScript at import time. This enables dynamic client-side description calculation.

### Generated Files

```
static/js/generated/
├── description_functions.js   # ~384KB, 1175 transpiled functions
└── game_data.js               # ~158KB, lookup tables
```

### File Structure

```
olden/
├── transpiler/                # Node.js transpiler
│   ├── package.json
│   ├── tsconfig.json
│   └── src/
│       ├── index.ts           # Main entry point
│       ├── tokenizer.ts       # Lexical analysis
│       ├── parser.ts          # AST generation
│       ├── codegen.ts         # JavaScript generation
│       └── data-extractor.ts  # Extract buff/ability lookup tables
├── static/js/
│   ├── description-runtime.js # Runtime support (memoization, formatters)
│   ├── hero-state.js          # Hero state model
│   └── generated/             # GENERATED by transpiler
│       ├── description_functions.js
│       └── game_data.js
└── tests/e2e/
    └── test_descriptions.py   # Playwright E2E tests
```

## How It Works

### 1. Localization Text (artifacts.json in texts/)

```json
{"sid": "knights_honor_armet_artifact_description", "text": "+{0} Defence."}
{"sid": "shamaniac_soul_gemwood_mask_artifact_description", "text": "The hero sees exact details of neutral armies within {0} squares."}
```

### 2. Args Mapping (artifacts.json in args/)

```json
{"sid": "knights_honor_armet_artifact_description", "args": ["current_item_param_1"]}
{"sid": "shamaniac_soul_gemwood_mask_artifact_description", "args": ["current_item_shamaniac_soul_gemwood_mask_artifact_param|alt_text_constNum3_radius"]}
```

The `|` character provides a fallback: if the first function fails, use the second.

### 3. Script Functions (item.script)

Functions are defined in a custom scripting language:

```
modInt current_item_param_1
{
    CurrentItem ( level, "level" )
    CurrentItem ( baseData, "config.bonuses[0].parameters[1]" )
    CurrentItem ( upgData, "config.bonuses[0].upgrade.increment" )

    Sub ( upgCount, level, 1 )
    Mul ( upgValue, upgData, upgCount )
    Add ( itemData, baseData, upgValue )

    Text( return, itemData )
}
```

This function:
1. Gets the item's current level
2. Gets base value from `bonuses[0].parameters[1]`
3. Gets upgrade increment
4. Calculates: `baseData + increment * (level - 1)`
5. Returns the result

### 4. Transpiled JavaScript

The transpiler converts the above to:

```javascript
DescriptionFunctions['current_item_param_1'] = DescriptionRuntime.memoize((ctx) => {
  const level = DescriptionRuntime.get(ctx.currentItem, 'level');
  const baseData = DescriptionRuntime.get(ctx.currentItem, 'config.bonuses[0].parameters[1]');
  const upgData = DescriptionRuntime.get(ctx.currentItem, 'config.bonuses[0].upgrade.increment');
  const upgCount = (Number(level) || 0) - (Number(1) || 0);
  const upgValue = (Number(upgData) || 0) * (Number(upgCount) || 0);
  const itemData = (Number(baseData) || 0) + (Number(upgValue) || 0);
  return DescriptionRuntime.formatModInt(itemData);
});
```

## Transpiler Operations

The transpiler supports 50+ operations:

| Category | Operations |
|----------|------------|
| Context | `CurrentItem`, `CurrentHero`, `CurrentSkillParameter`, `CurrentSubSkill`, `CurrentAbility`, `CurrentBuff`, `CurrentBuffSP`, `CurrentBuffStacks`, `CurrentUnitData`, `CurrentMagicBattle`, etc. |
| Database | `DbBuff`, `DbAbility`, `DbObstacle`, `DbTrap` |
| Arithmetic | `Add`, `Sub`, `Mul`, `Div`, `Avg`, `Floor` |
| Utility | `Text`, `Invoke`, `SpellpowerForCurrentMagic`, `Call`, `Return` |
| Lookups | `Ability`, `Unit`, `Hero` |

## Return Type Formatters

| Type | Description | Example |
|------|-------------|---------|
| `modInt` | Integer with +/- modifier | `+3`, `-2` |
| `modPercentNumeric` | Percentage (×100 if <1) | `+15%` |
| `modFloatPercentF1Numeric` | Float percentage | `+2.5%` |
| `string` | Raw string | `"40"` |
| `int` | Plain integer | `5` |
| `float` | Floating point | `1.5` |
| `Percent` | Percentage display | `50%` |

## Database Lookups (GameData)

Operations like `DbBuff("buff_blessing", "stats.offence")` need lookup tables at runtime.

**game_data.js** contains extracted data (~158KB):

```javascript
const GameData = {
  buffs: {          // 478 buffs
    "buff_blessing": { stats: { offence: 5, defence: 2 } },
    "buff_haste": { stats: { initiative: 3 } },
    // ...
  },
  abilities: { /* 21 abilities */ },
  obstacles: { /* 32 obstacles */ },
  traps: { /* 16 traps */ }
};
```

Data is extracted from:
- `DB/buffs/*.json` - Unit/spell buffs
- `DB/field_objects/obstacles/*.json` - Battlefield obstacles
- `DB/field_objects/traps/*.json` - Traps

## Runtime System

### description-runtime.js

```javascript
const DescriptionRuntime = {
  // LRU memoization (5 cached values per function)
  memoize(fn, maxSize = 5) { /* ... */ },

  // Value formatters
  formatModInt(v) { return v >= 0 ? `+${v}` : `${v}`; },
  formatModPercentNumeric(v) { /* multiply by 100 if < 1 */ },
  // ... other formatters

  // Path-based property accessor
  get(obj, path) { /* "config.bonuses[0].parameters[1]" */ },

  // Template formatting
  formatDescription(template, args, ctx) { /* ... */ }
};
```

### hero-state.js

```javascript
const HeroState = {
  hero: { stats: { viewRadius: 6, offence: 0, ... } },
  equipment: {},     // slot -> item
  spells: [],        // known spells
  skills: {},        // skill id -> level
  effects: [],       // stables, buffs, etc.

  get effectiveStats() { /* base + equipment bonuses */ },
  createItemContext(item) { /* for transpiled functions */ },
  formatItemDescription(item) { /* main API */ },
  updateAllDescriptions() { /* refresh on equipment change */ }
};
```

## Client-Side Integration

### Loading Generated Files (builder.html)

```html
<script src="{% static 'js/description-runtime.js' %}"></script>
<script src="{% static 'js/generated/game_data.js' %}"></script>
<script src="{% static 'js/generated/description_functions.js' %}"></script>
<script src="{% static 'js/hero-state.js' %}"></script>
```

### Description Formatting

```javascript
// Get description for item
formatItemDescription(itemData) {
  const template = itemData.description_template || '';
  const args = itemData.description_args || [];

  if (args.length === 0) return template;

  // Create context for transpiled functions
  const ctx = HeroState.createItemContext({
    ...itemData,
    level: itemData.level || 1
  });

  // Format using transpiled functions
  return DescriptionRuntime.formatDescription(template, args, ctx);
}
```

## Running the Transpiler

The transpiler runs automatically during `import_gamedata`:

```bash
python manage.py import_gamedata
```

Manual execution:

```bash
cd transpiler
npx ts-node src/index.ts /path/to/Core.zip /path/to/output/
```

Output:
- `description_functions.js` - All transpiled functions
- `game_data.js` - Buff/ability lookup tables

## Common Function Patterns

| Function Name | Description | Data Source |
|---------------|-------------|-------------|
| `current_item_param_1` | First bonus value with upgrade scaling | `bonuses[0].parameters[1]` |
| `current_item_param_2` | Second bonus value with upgrade scaling | `bonuses[1].parameters[1]` |
| `current_item_param_1_percent` | Same as param_1, formatted as percent | `bonuses[0].parameters[1]` |
| `current_item_param_1_int` | Parameter at index 3 (for special formats) | `bonuses[0].parameters[3]` |
| `current_item_increment_param_1` | Just the upgrade increment | `bonuses[0].upgrade.increment` |

## Special Cases

### Hero-Dependent Values

Some items calculate values based on hero stats:

```
modInt current_item_shamaniac_soul_gemwood_mask_artifact_param
{
    CurrentHero ( viewRadius, "heroStat.viewRadius" )
    Mul ( heroRadius, viewRadius, "3" )
    Text( return, heroRadius )
}
```

This gets the hero's `viewRadius` stat and multiplies by 3.

**Example:** Sirin Mask description "within {0} squares"
- Base viewRadius = 6 → shows "18 squares"
- With Head Torch (+2 viewRadius) → shows "24 squares"

### Hardcoded Values

Some items have hardcoded values:

```
string excalibur_artifact_param
{
    Text( return, "1" )
}
```

### Fallback Functions

Args with `|` provide fallbacks:

```json
{"args": ["primary_function|fallback_function"]}
```

If `primary_function` fails or returns undefined, `fallback_function` is tried.

## E2E Testing

Playwright tests verify the system works end-to-end:

```bash
pytest tests/e2e/test_descriptions.py -v
```

Test scenarios:
1. Hero builder loads without JS errors
2. Sirin Mask shows correct viewRadius-based value (18 squares)
3. Description updates when equipment changes stats
4. Item upgrade updates description values
5. Multiple placeholders are filled correctly
6. Generated JS files load successfully

## Bonus Data Structure

Item bonuses in raw_data follow this structure:

```json
{
  "bonuses": [
    {
      "type": "heroStat",
      "parameters": ["defence", "3"],  // [stat_name, base_value]
      "upgrade": {
        "increment": 1,
        "levelStep": 1
      }
    }
  ]
}
```

For `current_item_param_1`:
- Base value: `parameters[1]` = "3"
- Increment: `upgrade.increment` = 1
- At level 2: 3 + 1 * (2-1) = 4

## Related Files

- `/transpiler/` - Node.js script transpiler
- `/static/js/description-runtime.js` - Runtime support
- `/static/js/hero-state.js` - Hero state model
- `/static/js/generated/` - Generated JS files
- `/core/item_utils.py` - Bonus parsing utilities
- `/core/localizations.py` - Localization loading
- `/hero_builder/views.py` - API endpoint serving item data
- `/hero_builder/templates/hero_builder/builder.html` - Frontend integration
- `/gamedata/management/commands/import_gamedata.py` - Data import with transpiler
- `/tests/e2e/test_descriptions.py` - E2E Playwright tests
